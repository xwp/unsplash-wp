dist: xenial

language: php

services:
  - mysql

env:
  global:
    - PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true

addons:
  hosts:
    - mysql

notifications:
  email:
    on_success: never
    on_failure: change

cache:
  npm: true
  directories:
    - $HOME/.cache/composer
    - $HOME/.jest-cache
    - $HOME/.npm
    - $HOME/.nvm/.cache

before_install:
  - mysql < tests/phpunit/wptests.sql

install:
  - npm install
  - |
    if [ "$E2E" != "1" ]; then
      svn co -q https://core.svn.wordpress.org/${WP_VERSION}/ ./data/wordpress/html
      mkdir data/wordpress/html/wp-content/uploads
    fi

script:
  - |
    if [ "{PHP}" = "1" ]; then
      if [ "$COVERAGE" = "1" ]; then
        npm run test:php:coverage
      else
        npm run test:php
      fi
    fi

jobs:
  fast_finish: true
  include:
    - stage: lint
      name: Lint (PHP, JavaScript and CSS files)
      php: 7.4
      script:
        - npm run lint
      env: LINT=1 WP_VERSION=trunk
    - stage: unit-tests
      name: PHP unit tests (7.4, COVERAGE, WordPress trunk)
      php: 7.4
      env: PHP=1 COVERAGE=1 WP_VERSION=trunk
      after_success:
        -  npm run coverage:merge:php
        -  npm run coverage:php
    - name: PHP unit tests (7.3, WordPress trunk)
      php: 7.3
      env: PHP=1 WP_VERSION=trunk
    - name: PHP unit tests (7.0, WordPress trunk)
      php: 7.0
      env: PHP=1 WP_VERSION=trunk
    - name: PHP unit tests (5.6, WordPress trunk)
      php: 5.6
      env: PHP=1 WP_VERSION=trunk
    - stage: E2E
      name: E2E (7.4, WordPress trunk)
      php: 7.4
      script:
        - npm run build
        - sudo service mysql stop
        - npm run env:start && sleep 10
        - npm run env:setup
        - npm run e2e:ci
        - npm run env:stop
      env: E2E=1 WP_VERSION=trunk PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=
